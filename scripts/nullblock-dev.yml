name: nullblock-dev
root: ~/nullblock
startup_window: infrastructure

windows:
  - infrastructure:
      layout: even-horizontal
      panes:
        - |
          echo "Starting PostgreSQL..."
          brew services start postgresql@17
          echo "PostgreSQL started"
        - |
          echo "Starting Redis..."  
          brew services start redis
          echo "Redis started"
        - |
          echo "Starting IPFS..."
          ipfs daemon --enable-gc

  - backend:
      layout: tiled
      pre_window: |
        if [ -f .env.dev ]; then
          export $(grep -v '^#' .env.dev | xargs -0)
        fi
      panes:
        - |
          echo "Starting MCP Server..."
          cd svc/nullblock-mcp
          echo "Installing/updating dependencies with hatch..."
          hatch -e default run pip install -e .
          export MCP_SERVER_HOST=0.0.0.0
          export MCP_SERVER_PORT=8001
          hatch run python3 -m mcp
        - |
          echo "Starting Orchestration..."
          cd svc/nullblock-orchestration
          echo "Installing/updating dependencies with hatch..."
          hatch -e default run pip install -e .
          export ORCHESTRATION_HOST=0.0.0.0
          export ORCHESTRATION_PORT=8002
          hatch run python3 -m orchestration
        - |
          echo "Starting Erebus Server (Rust)..."
          cd svc/erebus
          mkdir -p logs
          export EREBUS_HOST=127.0.0.1
          export EREBUS_PORT=3000
          echo "ðŸ“ Logs will be written to logs/erebus.log"
          cargo run 2>&1 | tee logs/erebus.log

  - agents:
      layout: even-horizontal
      pre_window: |
        if [ -f .env.dev ]; then
          export $(grep -v '^#' .env.dev | xargs -0)
        fi
      panes:
        - |
          echo "ðŸ¤– Starting Nullblock Agents Server..."
          cd svc/nullblock-agents
          echo "Installing/updating dependencies with hatch..."
          hatch -e default run pip install -e .
          echo "Creating logs directory..."
          mkdir -p logs
          export AGENTS_HOST=0.0.0.0
          export AGENTS_PORT=9001
          echo "ðŸš€ Starting general agents server on port 9001..."
          echo "ðŸ“ Logs will be written to logs/agents.log"
          echo "ðŸ’¡ Use 'tail -f logs/agents.log' to monitor logs"
          hatch run python3 -m agents
        - |
          echo "ðŸŽ¯ Starting Hecate Agent Server with Dependencies..."
          echo "ðŸ“‹ This will wait for LM Studio to be ready before starting Hecate"
          echo ""
          exec ~/nullblock/scripts/start-hecate-with-deps.sh

  - frontend:
      panes:
        - |
          echo "Starting Frontend..."
          cd svc/hecate
          echo "Installing/updating npm dependencies..."
          npm install
          export VITE_MCP_API_URL=http://localhost:8001
          export VITE_EREBUS_API_URL=http://localhost:3000
          export VITE_ORCHESTRATION_API_URL=http://localhost:8002
          export VITE_AGENTS_API_URL=http://localhost:9001
          export VITE_HECATE_API_URL=http://localhost:9002
          npm run develop

  - llm:
      layout: even-horizontal
      panes:
        - ~/nullblock/scripts/start-lmstudio.sh
        - |
          echo "Waiting for LM Studio server to start..."
          sleep 10
          echo "ðŸ“Š Starting log monitoring..."
          echo "Press Ctrl+C to stop"
          echo ""
          echo "ðŸ“Š Monitoring LM Studio server logs..."
          mkdir -p logs
          while true; do 
            echo "$(date '+%Y-%m-%d %H:%M:%S') [LM-STUDIO-STREAM] Starting log stream capture" | tee -a logs/lm-studio-stream.log
            lms log stream 2>/dev/null | tee -a logs/lm-studio-stream.log || echo "âš ï¸  No recent log files found in LM Studio server logs" | tee -a logs/lm-studio-stream.log
            sleep 5
          done
        - ~/nullblock/scripts/wait-for-lmstudio.sh

  - logs:
      layout: tiled
      panes:
        - |
          echo "ðŸ“Š LM Studio Log Stream"
          echo "Monitoring LM Studio server logs..."
          echo "Press Ctrl+C to stop"
          echo ""
          echo "ðŸ“Š Monitoring LM Studio server logs..."
          mkdir -p logs
          while true; do 
            echo "$(date '+%Y-%m-%d %H:%M:%S') [LM-STUDIO-STREAM] Starting log stream capture" | tee -a logs/lm-studio-stream.log
            lms log stream 2>/dev/null | tee -a logs/lm-studio-stream.log || echo "âš ï¸  No recent log files found in LM Studio server logs" | tee -a logs/lm-studio-stream.log
            sleep 5
          done
        - ~/nullblock/scripts/wait-for-lmstudio.sh
        - |
          echo "ðŸŽ¯ Hecate Agent Logs"
          echo "Monitoring Hecate agent server and client logs..."
          echo ""
          mkdir -p svc/nullblock-agents/logs
          touch svc/nullblock-agents/logs/hecate-server.log
          tail -f svc/nullblock-agents/logs/hecate-server.log 2>/dev/null || echo "âš ï¸ Waiting for Hecate logs..."
        - |
          echo "ðŸ”— Erebus Server Logs"
          echo "Monitoring Erebus wallet server logs..."
          echo ""
          cd svc/erebus
          mkdir -p logs
          LOG_FILE="logs/erebus.log.$(date +%Y-%m-%d)"
          touch "$LOG_FILE"
          echo "ðŸ“ Tailing: $LOG_FILE"
          tail -f "$LOG_FILE" 2>/dev/null || echo "âš ï¸ Waiting for Erebus logs..."
        - |
          echo "ðŸŒ MCP Server Logs"
          echo "Monitoring MCP server logs..."
          echo ""
          mkdir -p svc/nullblock-mcp/logs
          touch svc/nullblock-mcp/logs/mcp-server.log
          tail -f svc/nullblock-mcp/logs/mcp-server.log 2>/dev/null || echo "âš ï¸ Waiting for MCP logs..."
        - ~/nullblock/scripts/health-monitor.sh

  - workspace:
      layout: even-horizontal
      panes:
        - |
          echo "Nullblock Main Repository"
          echo "Available commands:"
          echo "  just help - Show all commands"
          echo "  just dev-tmux - Launch dev environment"
          echo "  just start - Start all services"
          echo "  just status - Check service status"
          cd ~/nullblock
        - |
          echo "Nullblock SDK Repository"
          echo "Available commands:"
          echo "  npm run build - Build SDK"
          echo "  npm test - Run tests"
          echo "  npm run docs - Generate docs"
          cd ~/nullblock-sdk

on_project_start: |
  if [ ! -f .env.dev ]; then
    echo "Creating .env.dev file..."
    echo "# Nullblock Development Environment" > .env.dev
    echo "ETHEREUM_RPC_URL=https://eth-sepolia.alchemyapi.io/v2/your-key" >> .env.dev
    echo "Please edit .env.dev with your actual API keys"
  fi
  echo "ðŸ“ Creating comprehensive log directory structure..."
  mkdir -p logs
  mkdir -p svc/nullblock-agents/logs
  mkdir -p svc/nullblock-mcp/logs
  mkdir -p svc/nullblock-orchestration/logs
  mkdir -p svc/erebus/logs
  mkdir -p svc/hecate/logs
  echo "âœ… Log directories created with archival support"
  echo "ðŸš€ Nullblock development environment ready!"
  echo "ðŸ¤– Agents tab: General agents (9001) + Hecate server (9002) with comprehensive logging"
  echo "ðŸŒ Frontend connects to Hecate agent for chat functionality"
  echo "ðŸ“ All services now have persistent log files with rotation"
  echo "ðŸ’¡ Unified logs tab shows last 15 minutes by default"
  echo "ðŸ—‚ï¸  Log locations:"
  echo "   - Main: logs/"
  echo "   - Agents: svc/nullblock-agents/logs/"
  echo "   - MCP: svc/nullblock-mcp/logs/"
  echo "   - Orchestration: svc/nullblock-orchestration/logs/"
  echo "   - Erebus: svc/erebus/logs/"

on_project_stop: |
  echo "Stopping development services..."
  brew services stop postgresql@17 2>/dev/null || true
  brew services stop redis 2>/dev/null || true
  pkill -f "ipfs daemon" 2>/dev/null || true
