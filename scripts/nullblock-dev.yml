name: nullblock-dev
root: ~/nullblock
startup_window: monitoring

windows:
  - monitoring:
      layout: tiled
      panes:
        - |
          echo "ðŸŽ¯ NullBlock System Health Dashboard"
          echo "Comprehensive monitoring of all services and infrastructure..."
          echo ""
          mkdir -p logs
          while true; do
            clear
            echo "ðŸŽ¯ NullBlock System Health Dashboard - $(date '+%Y-%m-%d %H:%M:%S')"
            echo "==============================================================="
            echo ""

            # Service Health Checks
            echo "ðŸ“¡ Service Health Status:"
            for service in "erebus:3000" "nullblock-agents:9003" "nullblock-protocols:8001" "nullblock-engrams:9004" "arb-farm:9007" "frontend:5173"; do
              name=$(echo $service | cut -d: -f1)
              port=$(echo $service | cut -d: -f2)
              if curl -s --max-time 3 "http://localhost:$port/health" > /dev/null 2>&1; then
                echo "  âœ… $name (port $port) - Healthy"
              else
                echo "  âŒ $name (port $port) - Not responding"
              fi
            done
            echo ""

            # Database Connections (Docker)
            echo "ðŸ—„ï¸  Database Connections:"
            if docker ps | grep -q nullblock-postgres-agents && docker exec nullblock-postgres-agents pg_isready -U postgres > /dev/null 2>&1; then
              echo "  âœ… PostgreSQL (Agents) - Connected"
              echo "     ðŸ”‘ Test Credentials: postgres:REDACTED_DB_PASS@localhost:5441/agents"
            else
              echo "  âŒ PostgreSQL (Agents) - Connection failed"
              echo "     ðŸ”‘ Test Credentials: postgres:REDACTED_DB_PASS@localhost:5441/agents"
            fi

            if docker ps | grep -q nullblock-postgres-erebus && docker exec nullblock-postgres-erebus pg_isready -U postgres > /dev/null 2>&1; then
              echo "  âœ… PostgreSQL (Erebus) - Connected"
              echo "     ðŸ”‘ Test Credentials: postgres:REDACTED_DB_PASS@localhost:5440/erebus"
            else
              echo "  âŒ PostgreSQL (Erebus) - Connection failed"
              echo "     ðŸ”‘ Test Credentials: postgres:REDACTED_DB_PASS@localhost:5440/erebus"
            fi

            if docker ps | grep -q nullblock-redis && docker exec nullblock-redis redis-cli ping > /dev/null 2>&1; then
              echo "  âœ… Redis - Connected"
              echo "     ðŸ”‘ Test Credentials: localhost:6379 (no auth required)"
            else
              echo "  âŒ Redis - Connection failed"
              echo "     ðŸ”‘ Test Credentials: localhost:6379 (no auth required)"
            fi
            echo ""

            # Kafka Health
            echo "ðŸ“¨ Event Streaming:"
            if docker ps | grep -q nullblock-kafka; then
              echo "  âœ… Kafka - Running"
              echo "  âœ… Zookeeper - Running"
            else
              echo "  âŒ Kafka/Zookeeper - Not running (use docker-compose up kafka zookeeper -d)"
            fi

            sleep 30
          done
        - |
          echo "ðŸ“Š Task Management Metrics"
          echo "Real-time task and wallet-filtered task monitoring..."
          echo ""
          mkdir -p logs
          while true; do
            echo "$(date '+%Y-%m-%d %H:%M:%S') [METRICS] Task system status..." | tee -a logs/task-metrics.log

            # Test task endpoints (both direct and via Erebus)
            if curl -s --max-time 5 "http://localhost:3000/api/agents/tasks" > /dev/null 2>&1; then
              # Via Erebus (production route)
              task_response=$(curl -s "http://localhost:3000/api/agents/tasks" 2>/dev/null)
              if echo "$task_response" | jq -e '.data' > /dev/null 2>&1; then
                task_count=$(echo "$task_response" | jq '.data | length' 2>/dev/null || echo "0")
                echo "ðŸ“‹ Tasks via Erebus: $task_count" | tee -a logs/task-metrics.log
              else
                total_count=$(echo "$task_response" | jq '.total // 0' 2>/dev/null || echo "0")
                echo "ðŸ“‹ Total tasks: $total_count" | tee -a logs/task-metrics.log
              fi

              # Hecate agent model status
              echo "ðŸŽ¯ Agent model status:" | tee -a logs/task-metrics.log
              curl -s "http://localhost:9003/hecate/model-status" | jq -r '"  Model: " + (.current_model // "unknown") + " | Status: " + (.status // "unknown")' 2>/dev/null | tee -a logs/task-metrics.log

              # Wallet-based filtering test
              echo "ðŸ” Wallet filtering: Active (x-wallet-address headers)" | tee -a logs/task-metrics.log
            else
              echo "âŒ Task system not available via Erebus" | tee -a logs/task-metrics.log
            fi
            sleep 45
          done
        - |
          echo "ðŸ”„ Quick API Testing"
          echo "Testing all service endpoints..."
          echo ""
          while true; do
            echo "ðŸ§ª API Endpoint Tests - $(date '+%H:%M:%S')"
            echo "curl http://localhost:3000/health (Erebus)"
            curl -s --max-time 3 "http://localhost:3000/health" | jq . 2>/dev/null || echo "âŒ Failed"
            echo ""
            echo "curl http://localhost:9003/health (Agents)"
            curl -s --max-time 3 "http://localhost:9003/health" | jq . 2>/dev/null || echo "âŒ Failed"
            echo ""
            echo "curl http://localhost:3000/api/agents/tasks (Task Management via Erebus)"
            curl -s --max-time 3 "http://localhost:3000/api/agents/tasks" | jq '.data // .total // "error"' 2>/dev/null || echo "âŒ Failed"
            sleep 60
          done

  - erebus:
      layout: tiled
      pre_window: |
        if [ -f .env.dev ]; then
          export $(grep -v '^#' .env.dev | xargs -0)
        fi
      panes:
        - |
          echo "ðŸ”— Starting Erebus Server (Rust)..."
          cd svc/erebus
          mkdir -p logs
          export EREBUS_HOST=127.0.0.1
          export EREBUS_PORT=3000
          export DATABASE_URL="postgresql://postgres:REDACTED_DB_PASS@localhost:5440/erebus"
          export KAFKA_BOOTSTRAP_SERVERS="localhost:9092"
          echo "ðŸ“ Logs will be written to logs/erebus.log"
          echo ""
          echo "ðŸ—„ï¸  Waiting for Erebus database to be ready..."
          while ! docker exec nullblock-postgres-erebus pg_isready -U postgres > /dev/null 2>&1; do
            echo "â³ Waiting for Erebus PostgreSQL container to be ready..."
            sleep 2
          done
          echo "âœ… Erebus database connection ready"
          echo ""
          echo "ðŸ“‹ Running Erebus database migrations..."
          $HOME/nullblock/scripts/run-erebus-migrations.sh
          echo "âœ… Erebus migrations complete"
          echo ""
          echo "ðŸ“¨ Waiting for Kafka to be ready..."
          while ! docker exec nullblock-kafka kafka-broker-api-versions --bootstrap-server localhost:9092 > /dev/null 2>&1; do
            echo "â³ Waiting for Kafka container to be ready..."
            sleep 3
          done
          echo "âœ… Kafka connection ready"
          echo ""
          echo "ðŸš€ Starting Erebus Rust server..."
          cargo run 2>&1 | tee logs/erebus.log
        - |
          echo "ðŸ—„ï¸  Monitoring PostgreSQL for Erebus (Users DB)..."
          echo "Using Docker PostgreSQL container on port 5440..."
          echo ""
          echo "ðŸ“Š Database connection monitoring..."
          while true; do
            if docker ps | grep -q nullblock-postgres-erebus && docker exec nullblock-postgres-erebus pg_isready -U postgres > /dev/null 2>&1; then
              echo "$(date '+%H:%M:%S') âœ… Erebus PostgreSQL (Docker) connection healthy"
            else
              echo "$(date '+%H:%M:%S') âŒ Erebus PostgreSQL (Docker) connection failed"
            fi
            sleep 30
          done
        - |
          echo "ðŸ”„ Monitoring Redis for Erebus (Sessions)..."
          echo "Using Docker Redis container on port 6379..."
          echo ""
          echo "ðŸ“Š Redis connection monitoring..."
          while true; do
            if docker ps | grep -q nullblock-redis && docker exec nullblock-redis redis-cli ping > /dev/null 2>&1; then
              echo "$(date '+%H:%M:%S') âœ… Redis (Docker) connection healthy"
            else
              echo "$(date '+%H:%M:%S') âŒ Redis (Docker) connection failed"
            fi
            sleep 30
          done
        - |
          echo "ðŸ“¡ Erebus Service Logs & Monitoring"
          echo "Monitoring Erebus unified router logs and user events..."
          echo ""
          cd svc/erebus
          mkdir -p logs
          echo "ðŸ“ Watching Erebus logs..."
          tail -f logs/erebus.log 2>/dev/null || echo "âš ï¸ Waiting for Erebus logs..."

  - nullblock-agents:
      layout: tiled
      pre_window: |
        if [ -f .env.dev ]; then
          export $(grep -v '^#' .env.dev | xargs -0)
        fi
      panes:
        - |
          echo "ðŸŽ¯ Starting Hecate Agent Server (Rust)..."
          echo "ðŸ¦€ High-performance Rust implementation with database & events"
          echo ""
          cd svc/nullblock-agents
          mkdir -p logs
          export AGENTS_PORT=9003
          export DATABASE_URL="postgresql://postgres:REDACTED_DB_PASS@localhost:5441/agents"
          export KAFKA_BOOTSTRAP_SERVERS="localhost:9092"
          echo "ðŸš€ Starting Rust agents service on port 9003..."
          echo "ðŸ“ Logs will be written to logs/hecate-rust.log"
          echo "ðŸ—„ï¸  Using PostgreSQL for task persistence"
          echo "ðŸ“¨ Using Kafka for event streaming"
          echo ""
          echo "ðŸ—„ï¸  Setting up database schema..."
          echo "ðŸ“‹ Waiting for database to be ready..."
          while ! docker exec nullblock-postgres-agents pg_isready -U postgres > /dev/null 2>&1; do
            echo "â³ Waiting for PostgreSQL container to be ready..."
            sleep 2
          done
          echo "âœ… Database connection ready"
          echo ""
          echo "ðŸ“‹ Running database migrations..."
          cat $HOME/nullblock/svc/nullblock-agents/migrations/001_create_tasks_table.sql | docker exec -i nullblock-postgres-agents psql -U postgres -d agents 2>&1 | grep -E "(ERROR|already exists)" || echo "âœ… 001_create_tasks_table.sql applied"
          cat $HOME/nullblock/svc/nullblock-agents/migrations/002_create_agents_table.sql | docker exec -i nullblock-postgres-agents psql -U postgres -d agents 2>&1 | grep -E "(ERROR|already exists)" || echo "âœ… 002_create_agents_table.sql applied"
          cat $HOME/nullblock/svc/nullblock-agents/migrations/003_create_user_references_table.sql | docker exec -i nullblock-postgres-agents psql -U postgres -d agents 2>&1 | grep -E "(ERROR|already exists)" || echo "âœ… 003_create_user_references_table.sql applied"
          cat $HOME/nullblock/svc/nullblock-agents/migrations/004_add_tasks_foreign_keys.sql | docker exec -i nullblock-postgres-agents psql -U postgres -d agents 2>&1 | grep -E "(ERROR|already exists)" || echo "âœ… 004_add_tasks_foreign_keys.sql applied"
          cat $HOME/nullblock/svc/nullblock-agents/migrations/006_fix_user_references_constraint_name.sql | docker exec -i nullblock-postgres-agents psql -U postgres -d agents 2>&1 | grep -E "(ERROR|NOTICE|Renamed)" || echo "âœ… 006_fix_user_references_constraint_name.sql applied"
          cat $HOME/nullblock/svc/nullblock-agents/migrations/005_setup_replication_subscription.sql | docker exec -i nullblock-postgres-agents psql -U postgres -d agents 2>&1 | grep -E "(ERROR|NOTICE|Created)" || echo "âœ… 005_setup_replication_subscription.sql applied"
          echo "âœ… Database schema ready"
          echo ""
          echo "ðŸ“¨ Waiting for Kafka to be ready..."
          while ! docker exec nullblock-kafka kafka-broker-api-versions --bootstrap-server localhost:9092 > /dev/null 2>&1; do
            echo "â³ Waiting for Kafka container to be ready..."
            sleep 3
          done
          echo "âœ… Kafka connection ready"
          echo ""
          echo "ðŸš€ Starting Rust agents service..."
          cargo run --release 2>&1 | tee logs/hecate-rust.log
        - |
          echo "ðŸ—„ï¸  Agents Database Monitoring"
          echo "PostgreSQL monitoring for tasks, agents, user_references tables..."
          echo ""
          mkdir -p logs
          while true; do
            echo "$(date '+%Y-%m-%d %H:%M:%S') [DB] Agents database status..." | tee -a logs/agents-db.log
            if docker exec nullblock-postgres-agents psql -U postgres -d agents -c "SELECT COUNT(*) as task_count FROM tasks;" 2>/dev/null | grep -q "task_count"; then
              # Basic counts
              task_count=$(docker exec nullblock-postgres-agents psql -U postgres -d agents -t -c "SELECT COUNT(*) FROM tasks;" 2>/dev/null | xargs)
              user_ref_count=$(docker exec nullblock-postgres-agents psql -U postgres -d agents -t -c "SELECT COUNT(*) FROM user_references;" 2>/dev/null | xargs)
              agent_count=$(docker exec nullblock-postgres-agents psql -U postgres -d agents -t -c "SELECT COUNT(*) FROM agents;" 2>/dev/null | xargs)

              # Task status breakdown
              echo "ðŸ“Š Total: Tasks=$task_count | Users=$user_ref_count | Agents=$agent_count" | tee -a logs/agents-db.log

              # Task status distribution (aligned with new simplified status enum)
              created_tasks=$(docker exec nullblock-postgres-agents psql -U postgres -d agents -t -c "SELECT COUNT(*) FROM tasks WHERE status='created';" 2>/dev/null | xargs)
              running_tasks=$(docker exec nullblock-postgres-agents psql -U postgres -d agents -t -c "SELECT COUNT(*) FROM tasks WHERE status='running';" 2>/dev/null | xargs)
              completed_tasks=$(docker exec nullblock-postgres-agents psql -U postgres -d agents -t -c "SELECT COUNT(*) FROM tasks WHERE status='completed';" 2>/dev/null | xargs)
              failed_tasks=$(docker exec nullblock-postgres-agents psql -U postgres -d agents -t -c "SELECT COUNT(*) FROM tasks WHERE status='failed';" 2>/dev/null | xargs)
              paused_tasks=$(docker exec nullblock-postgres-agents psql -U postgres -d agents -t -c "SELECT COUNT(*) FROM tasks WHERE status='paused';" 2>/dev/null | xargs)
              cancelled_tasks=$(docker exec nullblock-postgres-agents psql -U postgres -d agents -t -c "SELECT COUNT(*) FROM tasks WHERE status='cancelled';" 2>/dev/null | xargs)

              echo "ðŸ“‹ Status: Created=$created_tasks | Running=$running_tasks | Completed=$completed_tasks | Failed=$failed_tasks | Paused=$paused_tasks | Cancelled=$cancelled_tasks" | tee -a logs/agents-db.log

              # Action tracking metrics (new feature)
              actioned_tasks=$(docker exec nullblock-postgres-agents psql -U postgres -d agents -t -c "SELECT COUNT(*) FROM tasks WHERE actioned_at IS NOT NULL;" 2>/dev/null | xargs)
              echo "âš¡ Actions: $actioned_tasks tasks have been processed by agents" | tee -a logs/agents-db.log

              # Recent activity
              recent_tasks=$(docker exec nullblock-postgres-agents psql -U postgres -d agents -t -c "SELECT COUNT(*) FROM tasks WHERE created_at >= NOW() - INTERVAL '1 hour';" 2>/dev/null | xargs)
              echo "â° Recent activity: $recent_tasks tasks created in last hour" | tee -a logs/agents-db.log
            else
              echo "âŒ Database not accessible or tables not created" | tee -a logs/agents-db.log
            fi
            sleep 45
          done
        - |
          echo "ðŸ“¨ Monitoring Kafka for Agents (Event Streaming)..."
          echo "Kafka and Zookeeper should be running via Docker..."
          echo ""
          echo "ðŸ“Š Kafka monitoring and topic management..."
          sleep 10
          echo "ðŸ“‹ Creating topics (if not exists)..."
          docker exec nullblock-kafka kafka-topics --create --topic task.lifecycle --bootstrap-server localhost:9092 --partitions 3 --replication-factor 1 2>/dev/null || echo "Topic already exists"
          docker exec nullblock-kafka kafka-topics --create --topic user.created --bootstrap-server localhost:9092 --partitions 3 --replication-factor 1 2>/dev/null || echo "Topic already exists"
          docker exec nullblock-kafka kafka-topics --create --topic user.updated --bootstrap-server localhost:9092 --partitions 3 --replication-factor 1 2>/dev/null || echo "Topic already exists"
          docker exec nullblock-kafka kafka-topics --create --topic user.deleted --bootstrap-server localhost:9092 --partitions 3 --replication-factor 1 2>/dev/null || echo "Topic already exists"
          echo "âœ… Topics created"
          echo ""
          echo "ðŸ“¨ Live Kafka Event Monitoring with Pretty JSON..."
          echo "ðŸ”„ Task Lifecycle Events | ðŸ‘¤ User Events | ðŸ“Š Event Counters"
          echo "=================================================="

          # Function to pretty print JSON with fallback
          pretty_json() {
            local line="$1"
            local topic="$2"
            local timestamp=$(date '+%H:%M:%S')
            
            # Try to parse as JSON and pretty print
            if echo "$line" | jq . >/dev/null 2>&1; then
              echo "$timestamp [$topic] ðŸ“„ Pretty JSON:"
              echo "$line" | jq . | sed 's/^/    /'
              echo ""
            else
              # Fallback to raw output if not valid JSON
              echo "$timestamp [$topic] ðŸ“„ Raw: $line"
            fi
          }

          # Start background consumers for different topics with JSON formatting
          (
            echo "ðŸ“‹ Task Lifecycle Events (Pretty JSON):"
            docker exec nullblock-kafka kafka-console-consumer \
              --bootstrap-server localhost:9092 \
              --topic task.lifecycle \
              --from-beginning 2>/dev/null | \
            while IFS= read -r line; do
              pretty_json "$line" "TASK"
            done
          ) &

          (
            echo "ðŸ‘¤ User Events (Pretty JSON):"
            for topic in user.created user.updated user.deleted; do
              docker exec nullblock-kafka kafka-console-consumer \
                --bootstrap-server localhost:9092 \
                --topic "$topic" \
                --from-beginning 2>/dev/null | \
              while IFS= read -r line; do
                pretty_json "$line" "USER-$topic"
              done &
            done
            wait
          ) &

          # Event counter with enhanced metrics
          while true; do
            echo "$(date '+%H:%M:%S') ðŸ“Š Kafka Event Metrics:"
            
            # Task events count
            task_events=$(docker exec nullblock-kafka kafka-run-class kafka.tools.ConsumerOffsetChecker \
              --zookeeper localhost:2181 \
              --topic task.lifecycle 2>/dev/null | awk '{sum+=$4} END {print sum+0}' 2>/dev/null || echo "0")
            echo "  ðŸ“‹ Task lifecycle events: $task_events"
            
            # User events count
            user_created=$(docker exec nullblock-kafka kafka-run-class kafka.tools.ConsumerOffsetChecker \
              --zookeeper localhost:2181 \
              --topic user.created 2>/dev/null | awk '{sum+=$4} END {print sum+0}' 2>/dev/null || echo "0")
            user_updated=$(docker exec nullblock-kafka kafka-run-class kafka.tools.ConsumerOffsetChecker \
              --zookeeper localhost:2181 \
              --topic user.updated 2>/dev/null | awk '{sum+=$4} END {print sum+0}' 2>/dev/null || echo "0")
            user_deleted=$(docker exec nullblock-kafka kafka-run-class kafka.tools.ConsumerOffsetChecker \
              --zookeeper localhost:2181 \
              --topic user.deleted 2>/dev/null | awk '{sum+=$4} END {print sum+0}' 2>/dev/null || echo "0")
            
            echo "  ðŸ‘¤ User events: created=$user_created, updated=$user_updated, deleted=$user_deleted"
            echo "  ðŸ“Š Total events: $((task_events + user_created + user_updated + user_deleted))"
            echo ""
            sleep 60
          done
        - |
          echo "ðŸŽ¯ Hecate Agent Health & Task Monitoring"
          echo "Real-time monitoring of agent health and task management..."
          echo ""
          mkdir -p logs
          while true; do
            echo "$(date '+%Y-%m-%d %H:%M:%S') [AGENT] Hecate health check..." | tee -a logs/hecate-health.log
            if curl -s --max-time 5 "http://localhost:9003/hecate/health" > /dev/null 2>&1; then
              echo "âœ… Hecate agent healthy" | tee -a logs/hecate-health.log

              # Model status
              curl -s "http://localhost:9003/hecate/model-status" | jq -r '"ðŸ§  Model: " + (.current_model // "unknown") + " | Status: " + (.status // "unknown")' 2>/dev/null | tee -a logs/hecate-health.log

              # Task count
              task_count=$(curl -s "http://localhost:9003/tasks" | jq '.total // 0' 2>/dev/null || echo "0")
              echo "ðŸ“‹ Current tasks: $task_count" | tee -a logs/hecate-health.log

              # Database migration status
              if curl -s --max-time 3 "http://localhost:9003/health" | jq -r '.components.database.status' 2>/dev/null | grep -q "healthy"; then
                echo "ðŸ—„ï¸  Database migrations: âœ… Complete" | tee -a logs/hecate-health.log
              else
                echo "ðŸ—„ï¸  Database migrations: âš ï¸  Check required" | tee -a logs/hecate-health.log
              fi
            else
              echo "âŒ Hecate agent not responding" | tee -a logs/hecate-health.log
            fi
            sleep 30
          done
        - |
          echo "ðŸ“Š Live System Logs - Multi-Service Tailing"
          echo "Real-time log monitoring across Hecate Agent, Erebus Router, and Task System..."
          echo ""
          mkdir -p logs
          echo "ðŸ”„ Starting multi-log tail with service prefixes..."
          echo "=================================================="

          # Multi-log tailing with service identification
          (
            echo "ðŸŽ¯ [HECATE] Starting Hecate Rust agent log monitoring..."
            tail -f $HOME/nullblock/svc/nullblock-agents/logs/hecate-rust.log 2>/dev/null | \
            while IFS= read -r line; do
              echo "$(date '+%H:%M:%S') [HECATE] $line"
            done
          ) &

          (
            echo "ðŸ”— [EREBUS] Starting Erebus router log monitoring..."
            tail -f $HOME/nullblock/svc/erebus/logs/erebus.log 2>/dev/null | \
            while IFS= read -r line; do
              echo "$(date '+%H:%M:%S') [EREBUS] $line"
            done
          ) &

          (
            echo "ðŸ“‹ [TASKS] Starting task system log monitoring..."
            tail -f $HOME/nullblock/logs/task-system.log 2>/dev/null | \
            while IFS= read -r line; do
              echo "$(date '+%H:%M:%S') [TASKS] $line"
            done
          ) &

          (
            echo "ðŸ—„ï¸  [DB] Starting database activity monitoring..."
            tail -f $HOME/nullblock/logs/agents-db.log 2>/dev/null | \
            while IFS= read -r line; do
              echo "$(date '+%H:%M:%S') [DB] $line"
            done
          ) &

          # Log summary every 2 minutes
          while true; do
            sleep 120
            echo "$(date '+%H:%M:%S') ðŸ“Š [SUMMARY] Multi-service logs active: Hecate Agent, Erebus Router, Task System, Database"
          done

  - nullblock-protocols:
      layout: tiled
      pre_window: |
        if [ -f .env.dev ]; then
          export $(grep -v '^#' .env.dev | xargs -0)
        fi
      panes:
        - |
          echo "ðŸŒ Starting Protocol Server..."
          cd svc/nullblock-protocols
          echo "ðŸ¦€ Starting Rust protocol service with A2A and MCP support..."
          export PORT=8001
          export DATABASE_URL="postgresql://postgres:REDACTED_DB_PASS@localhost:5441/agents"
          echo ""
          echo "ðŸ—„ï¸  Waiting for Agents database to be ready..."
          while ! docker exec nullblock-postgres-agents pg_isready -U postgres > /dev/null 2>&1; do
            echo "â³ Waiting for Agents PostgreSQL container to be ready..."
            sleep 2
          done
          echo "âœ… Agents database connection ready"
          echo ""
          echo "ðŸ“ Starting protocol server with database connection..."
          echo "ðŸ”— A2A JSON-RPC endpoint: http://localhost:8001/a2a/jsonrpc"
          echo "ðŸŒ A2A REST endpoints: http://localhost:8001/v1/*"
          echo "ðŸ“„ Agent Card: http://localhost:8001/v1/card"
          echo "ðŸ“¨ Messages: POST /v1/messages, /v1/messages/stream"
          echo "ðŸ“‹ Tasks: GET /v1/tasks, /v1/tasks/:id, POST /v1/tasks/:id/cancel"
          echo ""
          cargo run 2>&1 | tee logs/protocols-server.log
        - |
          echo "ðŸ—„ï¸  Protocol Service Database Integration Monitoring"
          echo "Monitoring Agents database connection for protocol service integration..."
          echo ""
          mkdir -p logs
          while true; do
            echo "$(date '+%Y-%m-%d %H:%M:%S') [AGENTS-DB] Database status..." | tee -a logs/agents-db.log
            if docker exec nullblock-postgres-agents pg_isready -U postgres > /dev/null 2>&1; then
              echo "âœ… PostgreSQL connection healthy" | tee -a logs/agents-db.log
            else
              echo "âŒ PostgreSQL connection failed" | tee -a logs/agents-db.log
            fi
            sleep 45
          done
        - |
          echo "ðŸ”— Protocol Health Monitoring..."
          echo "A2A and MCP protocol health monitoring..."
          echo ""
          echo "ðŸ“Š Protocol endpoint monitoring..."
          while true; do
            # Test A2A endpoints
            if curl -s --max-time 3 "http://localhost:8001/v1/card" > /dev/null 2>&1; then
              echo "$(date '+%H:%M:%S') âœ… A2A Agent Card endpoint healthy"
            else
              echo "$(date '+%H:%M:%S') âŒ A2A Agent Card endpoint not responding"
            fi

            if curl -s --max-time 3 "http://localhost:8001/health" > /dev/null 2>&1; then
              echo "$(date '+%H:%M:%S') âœ… Protocol health endpoint healthy"
            else
              echo "$(date '+%H:%M:%S') âŒ Protocol health endpoint not responding"
            fi
            sleep 60
          done
        - |
          echo "ðŸŒ Protocol Server Logs & Health"
          echo "Monitoring protocol server logs and A2A/MCP operations..."
          echo ""
          cd svc/nullblock-protocols
          mkdir -p logs
          tail -f logs/protocols-server.log 2>/dev/null || echo "âš ï¸ Waiting for protocol server logs..."

  - nullblock-engrams:
      layout: tiled
      pre_window: |
        if [ -f .env.dev ]; then
          export $(grep -v '^#' .env.dev | xargs -0)
        fi
      panes:
        - |
          echo "ðŸ§  Starting Engram Service (Rust)..."
          echo "Universal memory/context persistence layer for NullBlock"
          echo ""
          cd svc/nullblock-engrams
          mkdir -p logs
          export ENGRAMS_PORT=9004
          export DATABASE_URL="postgresql://postgres:REDACTED_DB_PASS@localhost:5441/agents"
          echo "ðŸš€ Starting Engram service on port 9004..."
          echo "ðŸ“ Logs will be written to logs/engrams.log"
          echo "ðŸ—„ï¸  Using PostgreSQL for engram persistence"
          echo ""
          echo "ðŸ—„ï¸  Waiting for database to be ready..."
          while ! docker exec nullblock-postgres-agents pg_isready -U postgres > /dev/null 2>&1; do
            echo "â³ Waiting for PostgreSQL container to be ready..."
            sleep 2
          done
          echo "âœ… Database connection ready"
          echo ""
          echo "ðŸ“‹ Running engram migrations..."
          cat $HOME/nullblock/svc/nullblock-engrams/migrations/001_create_engrams.sql | docker exec -i nullblock-postgres-agents psql -U postgres -d agents 2>&1 | grep -E "(ERROR|already exists)" || echo "âœ… 001_create_engrams.sql applied"
          echo "âœ… Engram database schema ready"
          echo ""
          echo "ðŸš€ Starting Engram service..."
          cargo run 2>&1 | tee logs/engrams.log
        - |
          echo "ðŸ“Š Engram Service Logs & Health Monitoring"
          echo "Monitoring engram service logs and operations..."
          echo ""
          cd svc/nullblock-engrams
          mkdir -p logs
          echo "ðŸ§  Watching Engram logs..."
          sleep 10
          tail -f logs/engrams.log 2>/dev/null || echo "âš ï¸ Waiting for Engram service logs..."
        - |
          echo "ðŸ”¬ Engram API Testing & Monitoring"
          echo "Interactive API testing for engram endpoints..."
          echo ""
          echo "ðŸ“¡ Engram Endpoints via Erebus (Port 3000):"
          echo "  POST   /api/engrams                - Create engram"
          echo "  GET    /api/engrams                - List engrams"
          echo "  GET    /api/engrams/:id            - Get by ID"
          echo "  PUT    /api/engrams/:id            - Update engram"
          echo "  DELETE /api/engrams/:id            - Delete engram"
          echo "  GET    /api/engrams/wallet/:wallet - Get by wallet"
          echo "  POST   /api/engrams/search         - Search engrams"
          echo "  POST   /api/engrams/:id/fork       - Fork engram"
          echo "  POST   /api/engrams/:id/publish    - Publish engram"
          echo ""
          echo "ðŸ§ª Running API health checks..."
          while true; do
            echo ""
            echo "$(date '+%Y-%m-%d %H:%M:%S') [ENGRAM] API Health Check..."

            # Direct engram service health
            if curl -s --max-time 3 "http://localhost:9004/health" > /dev/null 2>&1; then
              echo "âœ… Engram Service (9004) - Healthy"
              curl -s "http://localhost:9004/health" | jq . 2>/dev/null || echo "  (raw response)"
            else
              echo "âŒ Engram Service (9004) - Not responding"
            fi

            # Engram via Erebus
            if curl -s --max-time 3 "http://localhost:3000/api/engrams/health" > /dev/null 2>&1; then
              echo "âœ… Engram via Erebus (3000) - Healthy"
            else
              echo "âš ï¸  Engram via Erebus (3000) - Not responding (Erebus may not be running)"
            fi

            # Engram count
            engram_response=$(curl -s --max-time 3 "http://localhost:9004/engrams?limit=1" 2>/dev/null)
            if [ ! -z "$engram_response" ]; then
              total=$(echo "$engram_response" | jq '.total // 0' 2>/dev/null || echo "0")
              echo "ðŸ“Š Total engrams in database: $total"
            fi

            sleep 45
          done
        - |
          echo "ðŸ”§ Engram Interactive Shell"
          echo "Use this pane for manual API testing..."
          echo ""
          echo "ðŸ“ Example Commands:"
          echo ""
          echo "# Create an engram:"
          echo 'curl -X POST http://localhost:3000/api/engrams \'
          echo '  -H "Content-Type: application/json" \'
          echo '  -d '"'"'{"wallet_address":"0x123","engram_type":"persona","key":"test.persona","content":{"name":"Test"},"tags":["test"]}'"'"' | jq .'
          echo ""
          echo "# List engrams:"
          echo "curl -s http://localhost:3000/api/engrams | jq ."
          echo ""
          echo "# Search engrams:"
          echo 'curl -X POST http://localhost:3000/api/engrams/search \'
          echo '  -H "Content-Type: application/json" \'
          echo '  -d '"'"'{"engram_type":"persona","tags":["test"]}'"'"' | jq .'
          echo ""
          echo "# Get by wallet:"
          echo "curl -s http://localhost:3000/api/engrams/wallet/0x123 | jq ."
          echo ""
          echo "Ready for interactive testing..."
          bash

  - arb-farm:
      layout: tiled
      pre_window: |
        if [ -f .env.dev ]; then
          export $(grep -v '^#' .env.dev | xargs -0)
        fi
      panes:
        - |
          echo "âš¡ Starting ArbFarm Service (Solana MEV)..."
          echo "Observation mode: scanner ON, execution OFF by default"
          echo ""
          cd svc/arb-farm
          mkdir -p logs
          export ARB_FARM_PORT=9007
          export DATABASE_URL="postgresql://postgres:REDACTED_DB_PASS@localhost:5441/agents"
          echo "ðŸš€ Starting ArbFarm service on port 9007..."
          echo "ðŸ“ Logs will be written to logs/arb-farm.log"
          echo ""
          echo "ðŸ—„ï¸  Waiting for database to be ready..."
          while ! docker exec nullblock-postgres-erebus pg_isready -U postgres > /dev/null 2>&1; do
            echo "â³ Waiting for PostgreSQL container to be ready..."
            sleep 2
          done
          echo "âœ… Database connection ready"
          echo ""
          echo "ðŸš€ Starting ArbFarm service..."
          cargo run --release 2>&1 | tee logs/arb-farm.log
        - |
          echo "ðŸ“Š ArbFarm Health & Contenders"
          echo "Waiting for ArbFarm service..."
          echo ""
          while ! curl -s --max-time 3 "http://localhost:9007/health" > /dev/null 2>&1; do
            sleep 3
          done
          echo "âœ… ArbFarm is up (observation mode)"
          sleep 2
          while true; do
            clear
            RISK_LEVEL=$(curl -s http://localhost:9007/config/risk 2>/dev/null | jq -r '.level // "unknown"' | tr '[:lower:]' '[:upper:]')
            echo "âš¡ ArbFarm - $(date '+%H:%M:%S') [RISK: $RISK_LEVEL]"
            echo "================================"
            curl -s http://localhost:9007/scanner/status 2>/dev/null | jq -r '"Scanner: Running=\(.is_running) | Scans=\(.stats.total_scans) | Signals=\(.stats.total_signals)"' || true
            EXEC_RUNNING=$(curl -s http://localhost:9007/executor/stats 2>/dev/null | jq -r '.is_running // false')
            curl -s http://localhost:9007/executor/stats 2>/dev/null | jq -r '"Executor: Running=\(.is_running) | Executed=\(.executions_succeeded)"' || true
            curl -s http://localhost:9007/positions/monitor/status 2>/dev/null | jq -r '"Monitor: Positions=\(.active_positions)"' || true
            if [ "$EXEC_RUNNING" != "true" ]; then
              echo ""
              echo "âš ï¸  OBSERVATION MODE - signals are buy candidates (execution off)"
            fi
            echo ""
            curl -s http://localhost:9007/wallet/balance 2>/dev/null | jq -r '"ðŸ’° Balance: \(.balance_sol) SOL"' || true
            echo ""
            echo "ðŸŽ“ Top Contenders (approaching graduation)"
            curl -s 'http://localhost:9007/scanner/contenders?limit=5' 2>/dev/null | jq -r '
              if .count == 0 then "  No contenders yet (waiting for scan data)"
              else .contenders[]? | "  \(.symbol) \(.graduation_progress | . * 10 | floor / 10)% | \(.market_cap_sol | . * 100 | floor / 100) SOL"
              end
            ' || echo "  Failed to get contenders"
            sleep 5
          done
        - |
          echo "ðŸ“¡ ArbFarm Event Stream"
          echo "Waiting for ArbFarm..."
          while ! curl -s --max-time 3 "http://localhost:9007/health" > /dev/null 2>&1; do
            sleep 3
          done
          echo "âœ… Connecting to event stream..."
          while true; do
            curl -sN http://localhost:9007/events/stream 2>/dev/null | while read line; do
              if [[ "$line" == data:* ]]; then
                json="${line#data: }"
                ts=$(echo "$json" | jq -r '.timestamp[11:19]' 2>/dev/null)
                evt=$(echo "$json" | jq -r '.event_type' 2>/dev/null)
                if [ -n "$ts" ] && [ "$ts" != "null" ]; then
                  echo "$ts | $evt"
                fi
              fi
            done
            echo "$(date '+%H:%M:%S') | Connection lost, retrying..."
            sleep 5
          done
        - |
          echo "ðŸ“ˆ ArbFarm Logs"
          echo "Watching ArbFarm service logs..."
          echo ""
          cd svc/arb-farm
          mkdir -p logs
          tail -f logs/arb-farm.log 2>/dev/null || echo "âš ï¸ Waiting for ArbFarm logs..."

  - task-management:
      layout: tiled
      pre_window: |
        if [ -f .env.dev ]; then
          export $(grep -v '^#' .env.dev | xargs -0)
        fi
      panes:
        - |
          echo "ðŸ“‹ Task Management System"
          echo "The orchestration service has been integrated into the Hecate Agent (Rust)"
          echo "Task management is now handled directly by the agents service on port 9003"
          echo ""
          echo "ðŸ”„ Monitoring Task System Performance..."
          while true; do
            echo "$(date '+%Y-%m-%d %H:%M:%S') [TASK-SYS] Task system metrics..."

            # Task API health via Erebus
            if curl -s --max-time 3 "http://localhost:3000/api/agents/tasks" > /dev/null 2>&1; then
              echo "âœ… Task API via Erebus - Healthy"
            else
              echo "âŒ Task API via Erebus - Failed"
            fi

            # Direct agent API health
            if curl -s --max-time 3 "http://localhost:9003/health" > /dev/null 2>&1; then
              echo "âœ… Hecate Agent Direct API - Healthy"
            else
              echo "âŒ Hecate Agent Direct API - Failed"
            fi

            sleep 60
          done

  - frontend:
      panes:
        - |
          echo "ðŸŽ¨ Starting Frontend (Hecate React App)..."
          cd svc/hecate
          echo "Installing/updating npm dependencies..."
          npm install
          export VITE_PROTOCOLS_API_URL=http://localhost:8001
          export VITE_A2A_API_URL=http://localhost:8001
          export VITE_EREBUS_API_URL=http://localhost:3000
          export VITE_HECATE_API_URL=http://localhost:9003
          echo "ðŸš€ Starting React development server..."
          npm run develop

on_project_start: |
  if [ ! -f .env.dev ]; then
    echo "Creating .env.dev file..."
    echo "# Nullblock Development Environment" > .env.dev
    echo "ETHEREUM_RPC_URL=https://eth-sepolia.alchemyapi.io/v2/your-key" >> .env.dev
    echo "OPENROUTER_API_KEY=your-openrouter-key-here" >> .env.dev
    echo "Please edit .env.dev with your actual API keys"
  fi
  echo "ðŸ“ Creating log directory structure..."
  mkdir -p logs
  mkdir -p svc/nullblock-agents/logs
  mkdir -p svc/nullblock-protocols/logs
  mkdir -p svc/nullblock-engrams/logs
  mkdir -p svc/erebus/logs
  mkdir -p svc/hecate/logs
  mkdir -p svc/arb-farm/logs
  echo "âœ… Log directories created"
  echo ""
  echo "ðŸš€ Starting all infrastructure services using 'just start'..."
  just start
  echo ""
  echo "ðŸš€ Nullblock Development Environment Ready!"
  echo "================================================"
  echo "ðŸ—ï¸  Architecture: Client â†” Erebus â†” Services"
  echo "ðŸ›¡ï¸  Security: All frontend requests route through Erebus (port 3000)"
  echo ""
  echo "ðŸ“¡ Service Ports:"
  echo "   ðŸŒ Erebus (unified router): http://localhost:3000"
  echo "   ðŸŒ Protocol Server (A2A/MCP): http://localhost:8001"
  echo "   ðŸŽ¯ Hecate Agent (Rust): http://localhost:9003"
  echo "   ðŸ§  Engram Service: http://localhost:9004"
  echo "   âš¡ ArbFarm (Solana MEV): http://localhost:9007"
  echo "   ðŸŽ¨ Frontend: http://localhost:5173"
  echo ""
  echo "ðŸ¦€ Rust Services:"
  echo "   âœ… Hecate Agent - High-performance conversational AI"
  echo "   âœ… Erebus Router - Unified request routing & logging"
  echo "   âœ… Protocol Server - A2A and MCP protocol communication"
  echo "   âœ… Engram Service - Universal memory/context persistence"
  echo "   âœ… ArbFarm - Solana MEV agent swarm"
  echo ""
  echo "ðŸŒ A2A Protocol Integration:"
  echo "   ðŸ“‹ Specification: https://a2a-protocol.org/latest/specification/"
  echo "   ðŸ”— JSON-RPC endpoint: http://localhost:8001/a2a/jsonrpc"
  echo "   ðŸŒ REST endpoints: http://localhost:8001/v1/*"
  echo "   ðŸ“„ Agent Card: http://localhost:8001/v1/card"
  echo ""
  echo "ðŸ§  LLM Integration:"
  echo "   âš¡ Provider: OpenRouter (cloud-based)"
  echo "   ðŸŽ¯ Default Model: deepseek/deepseek-chat-v3.1:free ($0.00)"
  echo "   ðŸ’° Cost Tracking: Real-time monitoring & analytics"
  echo ""
  echo "ðŸ“‹ Task Management:"
  echo "   ðŸ—ï¸  Architecture: Simplified & wallet-based filtering"
  echo "   ðŸ“Š Categories: Todo, Running, Completed tabs"
  echo "   ðŸ” Security: Wallet-scoped tasks with headers"
  echo "   âš¡ Actions: Full lifecycle tracking & agent execution"
  echo ""
  echo "ðŸ“Š Tabs Overview:"
  echo "   ðŸ“ monitoring - Real-time service health & task metrics"
  echo "   ðŸ”— erebus - Unified router with wallet & session management"
  echo "   ðŸŽ¯ nullblock-agents - Hecate Agent (Rust) with task system"
  echo "   ðŸŒ nullblock-protocols - Multi-protocol server (A2A/MCP) with agent communication"
  echo "   ðŸ§  nullblock-engrams - Memory/context persistence layer"
  echo "   âš¡ arb-farm - Solana MEV agent swarm"
  echo "   ðŸ“‹ task-management - Integrated task system monitoring"
  echo "   ðŸŽ¨ frontend - React development server with wallet integration"

on_project_stop: |
  echo "ðŸ›‘ Stopping development services using 'just term'..."
  just term
  echo "Stopping IPFS daemon..."
  pkill -f "ipfs daemon" 2>/dev/null || true
  echo "âœ… All services stopped and cleaned up"