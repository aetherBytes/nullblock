name: nullblock-dev
root: ~/nullblock
startup_window: monitoring

windows:
  - monitoring:
      layout: tiled
      panes:
        - ~/nullblock/scripts/monitor-health.sh
        - ~/nullblock/scripts/monitor-tasks.sh
        - ~/nullblock/scripts/monitor-api.sh

  - erebus:
      layout: tiled
      pre_window: |
        if [ -f .env.dev ]; then
          set -a
          source .env.dev
          set +a
        fi
      panes:
        - ~/nullblock/scripts/start-erebus.sh
        - ~/nullblock/scripts/monitor-erebus-db.sh
        - ~/nullblock/scripts/monitor-erebus-redis.sh
        - ~/nullblock/scripts/tail-erebus-logs.sh

  - nullblock-agents:
      layout: tiled
      pre_window: |
        if [ -f .env.dev ]; then
          set -a
          source .env.dev
          set +a
        fi
      panes:
        - ~/nullblock/scripts/start-agents.sh
        - ~/nullblock/scripts/monitor-agents-db.sh
        - ~/nullblock/scripts/monitor-kafka-simple.sh
        - ~/nullblock/scripts/monitor-hecate-health.sh

  - nullblock-protocols:
      layout: tiled
      pre_window: |
        if [ -f .env.dev ]; then
          set -a
          source .env.dev
          set +a
        fi
      panes:
        - ~/nullblock/scripts/start-protocols.sh
        - ~/nullblock/scripts/monitor-protocol-db.sh
        - ~/nullblock/scripts/monitor-protocol-health.sh
        - ~/nullblock/scripts/tail-protocol-logs.sh

  - nullblock-engrams:
      layout: tiled
      pre_window: |
        if [ -f .env.dev ]; then
          set -a
          source .env.dev
          set +a
        fi
      panes:
        - ~/nullblock/scripts/start-engrams.sh
        - ~/nullblock/scripts/tail-engrams-logs.sh
        - ~/nullblock/scripts/monitor-engrams-api.sh
        - ~/nullblock/scripts/engrams-shell.sh

  - arb-farm:
      layout: tiled
      pre_window: |
        if [ -f .env.dev ]; then
          set -a
          source .env.dev
          set +a
        fi
      panes:
        - ~/nullblock/scripts/start-arb-farm.sh
        - ~/nullblock/scripts/arb-monitor-health.sh
        - ~/nullblock/scripts/arb-monitor-events.sh
        - ~/nullblock/scripts/arb-monitor-positions.sh

  - task-management:
      layout: tiled
      pre_window: |
        if [ -f .env.dev ]; then
          set -a
          source .env.dev
          set +a
        fi
      panes:
        - ~/nullblock/scripts/monitor-task-system.sh

  - frontend:
      panes:
        - ~/nullblock/scripts/start-frontend.sh

  - docs:
      panes:
        - cd ~/nullblock/docs-internal && mdbook serve --port 3001

on_project_start: |
  if [ ! -f .env.dev ]; then
    echo "Creating .env.dev file..."
    echo "# Nullblock Development Environment" > .env.dev
    echo "ETHEREUM_RPC_URL=https://eth-sepolia.alchemyapi.io/v2/your-key" >> .env.dev
    echo "OPENROUTER_API_KEY=your-openrouter-key-here" >> .env.dev
    echo "Please edit .env.dev with your actual API keys"
  fi
  echo "ğŸ§¹ Cleaning up orphaned service processes..."
  for port in 3000 3001 8001 9003 9004 9007; do
    pid=$(lsof -ti :$port 2>/dev/null)
    if [ -n "$pid" ]; then
      echo "   Killing process on port $port (PID: $pid)"
      kill $pid 2>/dev/null || true
    fi
  done
  sleep 1
  echo "âœ… Ports cleared"
  echo "ğŸŒ Opening development URLs in default browser..."
  sleep 2
  open "http://localhost:5173" "http://localhost:3001"
  echo "âœ… Browser tabs opened"
  echo "ğŸ“ Creating log directory structure..."
  mkdir -p logs
  mkdir -p svc/nullblock-agents/logs
  mkdir -p svc/nullblock-protocols/logs
  mkdir -p svc/nullblock-engrams/logs
  mkdir -p svc/erebus/logs
  mkdir -p svc/hecate/logs
  mkdir -p svc/arb-farm/logs
  echo "âœ… Log directories created"
  echo ""
  echo "ğŸš€ Starting all infrastructure services using 'just start'..."
  just start
  echo ""
  echo "ğŸ—„ï¸ Running ArbFarm database migrations..."
  sleep 3  # Wait for postgres to be ready
  ~/nullblock/scripts/migrate-arbfarm.sh || echo "âš ï¸ Migration may have failed, check database"
  echo ""
  echo "ğŸš€ Nullblock Development Environment Ready (macOS)!"
  echo "================================================"
  echo "ğŸ—ï¸  Architecture: Client â†” Erebus â†” Services"
  echo "ğŸ›¡ï¸  Security: All frontend requests route through Erebus (port 3000)"
  echo ""
  echo "ğŸ“¡ Service Ports:"
  echo "   ğŸŒ Erebus (unified router): http://localhost:3000"
  echo "   ğŸŒ Protocol Server (A2A/MCP): http://localhost:8001"
  echo "   ğŸ¯ Hecate Agent (Rust): http://localhost:9003"
  echo "   ğŸ§  Engram Service: http://localhost:9004"
  echo "   âš¡ ArbFarm (Solana MEV): http://localhost:9007"
  echo "   ğŸ¨ Frontend: http://localhost:5173"
  echo "   ğŸ“š Internal Docs: http://localhost:3001"
  echo ""
  echo "ğŸ¦€ Rust Services:"
  echo "   âœ… Hecate Agent - High-performance conversational AI"
  echo "   âœ… Erebus Router - Unified request routing & logging"
  echo "   âœ… Protocol Server - A2A and MCP protocol communication"
  echo "   âœ… Engram Service - Universal memory/context persistence"
  echo "   âœ… ArbFarm - Solana MEV agent swarm"
  echo "   ğŸ“š mdBook Docs - Internal documentation with live reload"
  echo ""
  echo "ğŸŒ A2A Protocol Integration:"
  echo "   ğŸ“‹ Specification: https://a2a-protocol.org/latest/specification/"
  echo "   ğŸ”— JSON-RPC endpoint: http://localhost:8001/a2a/jsonrpc"
  echo "   ğŸŒ REST endpoints: http://localhost:8001/v1/*"
  echo "   ğŸ“„ Agent Card: http://localhost:8001/v1/card"
  echo ""
  echo "ğŸ§  LLM Integration:"
  echo "   âš¡ Provider: OpenRouter (cloud-based)"
  echo "   ğŸ¯ Default Model: deepseek/deepseek-chat-v3.1:free ($0.00)"
  echo "   ğŸ’° Cost Tracking: Real-time monitoring & analytics"

on_project_stop: |
  echo "ğŸ›‘ Stopping development services using 'just term'..."
  just term
  echo "âœ… All services stopped and cleaned up"
