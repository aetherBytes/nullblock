name: nullblock-dev
root: ~/nullblock
startup_window: monitoring

windows:
  - monitoring:
      layout: tiled
      panes:
        - ~/nullblock/scripts/monitor-health.sh
        - ~/nullblock/scripts/monitor-tasks.sh
        - ~/nullblock/scripts/monitor-api.sh

  - erebus:
      layout: tiled
      pre_window: |
        if [ -f .env.dev ]; then
          set -a
          source .env.dev
          set +a
        fi
      panes:
        - ~/nullblock/scripts/start-erebus.sh
        - ~/nullblock/scripts/monitor-erebus-db.sh
        - ~/nullblock/scripts/monitor-erebus-redis.sh
        - ~/nullblock/scripts/tail-erebus-logs.sh

  - nullblock-agents:
      layout: tiled
      pre_window: |
        if [ -f .env.dev ]; then
          set -a
          source .env.dev
          set +a
        fi
      panes:
        - ~/nullblock/scripts/start-agents.sh
        - ~/nullblock/scripts/monitor-agents-db.sh
        - ~/nullblock/scripts/monitor-kafka-simple.sh
        - ~/nullblock/scripts/monitor-hecate-health.sh

  - nullblock-protocols:
      layout: tiled
      pre_window: |
        if [ -f .env.dev ]; then
          set -a
          source .env.dev
          set +a
        fi
      panes:
        - ~/nullblock/scripts/start-protocols.sh
        - ~/nullblock/scripts/monitor-protocol-db.sh
        - ~/nullblock/scripts/monitor-protocol-health.sh
        - ~/nullblock/scripts/tail-protocol-logs.sh

  - task-management:
      layout: tiled
      pre_window: |
        if [ -f .env.dev ]; then
          set -a
          source .env.dev
          set +a
        fi
      panes:
        - ~/nullblock/scripts/monitor-task-system.sh

  - frontend:
      panes:
        - |
          echo "ðŸŽ¨ Starting Frontend (Hecate React App)..."
          echo "=============================================="
          cd svc/hecate
          echo ""
          echo "ðŸ“‹ Environment Info:"
          echo "   Node: $(node --version)"
          echo "   npm:  $(npm --version)"
          echo ""
          echo "ðŸ”— API Endpoints:"
          export VITE_PROTOCOLS_API_URL=http://localhost:8001
          export VITE_A2A_API_URL=http://localhost:8001
          export VITE_EREBUS_API_URL=http://localhost:3000
          export VITE_HECATE_API_URL=http://localhost:9003
          echo "   VITE_EREBUS_API_URL=$VITE_EREBUS_API_URL"
          echo "   VITE_PROTOCOLS_API_URL=$VITE_PROTOCOLS_API_URL"
          echo "   VITE_HECATE_API_URL=$VITE_HECATE_API_URL"
          echo ""
          echo "ðŸ”§ Chrome DevTools MCP:"
          echo "   Debug port: 9222"
          echo "   Profile: /tmp/chrome-nullblock-dev"
          echo ""
          echo "ðŸ§¹ Clearing Vite cache..."
          rm -rf node_modules/.vite
          echo "ðŸ“¦ Installing/updating npm dependencies..."
          npm install --silent
          echo ""
          echo "â³ Waiting for backend services..."
          for i in {1..30}; do
            if curl -s http://localhost:3000/health > /dev/null 2>&1; then
              echo "âœ… Erebus ready"
              break
            fi
            sleep 1
          done
          echo ""
          echo "ðŸš€ Starting Vite dev server..."
          npm run develop

on_project_start: |
  if [ ! -f .env.dev ]; then
    echo "Creating .env.dev file..."
    echo "# Nullblock Development Environment" > .env.dev
    echo "ETHEREUM_RPC_URL=https://eth-sepolia.alchemyapi.io/v2/your-key" >> .env.dev
    echo "OPENROUTER_API_KEY=your-openrouter-key-here" >> .env.dev
    echo "Please edit .env.dev with your actual API keys"
  fi
  echo "ðŸŒ Starting Chrome with remote debugging (port 9222)..."
  pkill -f "Chrome.*remote-debugging-port=9222" 2>/dev/null || true
  sleep 1
  /Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome \
    --remote-debugging-port=9222 \
    --user-data-dir=/tmp/chrome-nullblock-dev \
    --no-first-run \
    --no-default-browser-check \
    "http://localhost:5173" &
  echo "âœ… Chrome DevTools MCP ready on port 9222"
  echo "ðŸ“ Creating log directory structure..."
  mkdir -p logs
  mkdir -p svc/nullblock-agents/logs
  mkdir -p svc/nullblock-protocols/logs
  mkdir -p svc/erebus/logs
  mkdir -p svc/hecate/logs
  echo "âœ… Log directories created"
  echo ""
  echo "ðŸš€ Starting all infrastructure services using 'just start'..."
  just start
  echo ""
  echo "ðŸš€ Nullblock Development Environment Ready (macOS)!"
  echo "================================================"
  echo "ðŸ—ï¸  Architecture: Client â†” Erebus â†” Services"
  echo "ðŸ›¡ï¸  Security: All frontend requests route through Erebus (port 3000)"
  echo ""
  echo "ðŸ“¡ Service Ports:"
  echo "   ðŸŒ Erebus (unified router): http://localhost:3000"
  echo "   ðŸŒ Protocol Server (A2A/MCP): http://localhost:8001"
  echo "   ðŸŽ¯ Hecate Agent (Rust): http://localhost:9003"
  echo "   ðŸŽ¨ Frontend: http://localhost:5173"
  echo "   ðŸ”§ Chrome DevTools (MCP): localhost:9222"
  echo ""
  echo "ðŸ¦€ Rust Services:"
  echo "   âœ… Hecate Agent - High-performance conversational AI"
  echo "   âœ… Erebus Router - Unified request routing & logging"
  echo "   âœ… Protocol Server - A2A and MCP protocol communication"
  echo ""
  echo "ðŸŒ A2A Protocol Integration:"
  echo "   ðŸ“‹ Specification: https://a2a-protocol.org/latest/specification/"
  echo "   ðŸ”— JSON-RPC endpoint: http://localhost:8001/a2a/jsonrpc"
  echo "   ðŸŒ REST endpoints: http://localhost:8001/v1/*"
  echo "   ðŸ“„ Agent Card: http://localhost:8001/v1/card"
  echo ""
  echo "ðŸ§  LLM Integration:"
  echo "   âš¡ Provider: OpenRouter (cloud-based)"
  echo "   ðŸŽ¯ Default Model: deepseek/deepseek-chat-v3.1:free ($0.00)"
  echo "   ðŸ’° Cost Tracking: Real-time monitoring & analytics"

on_project_stop: |
  echo "ðŸ›‘ Stopping development services using 'just term'..."
  just term
  echo "ðŸŒ Stopping Chrome debug instance..."
  pkill -f "Chrome.*remote-debugging-port=9222" 2>/dev/null || true
  echo "âœ… All services stopped and cleaned up"
