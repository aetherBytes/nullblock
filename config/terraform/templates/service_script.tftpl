#!/bin/bash

# Generated service management script for Nullblock services
# Generated by Terraform for environment: ${environment}
# Generated on: ${formatdate("YYYY-MM-DD HH:mm:ss", timestamp())}
# Action: ${action}

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

echo "ğŸ”§ NULLBLOCK SERVICE MANAGEMENT"
echo "=============================="
echo "Environment: ${environment}"
echo "Action: ${action}"
echo "Generated: ${formatdate("YYYY-MM-DD HH:mm:ss", timestamp())}"
echo ""

# Function to check if a service is running
check_service() {
    local name="$1"
    local port="$2"
    local url="$3"
    local check_type="$4"
    
    if [ "$check_type" = "port" ]; then
        if lsof -i :$port > /dev/null 2>&1; then
            echo "âœ…"
        else
            echo "âŒ"
        fi
    elif [ "$check_type" = "http" ]; then
        if curl -s --max-time 3 "$url" > /dev/null 2>&1; then
            echo "âœ…"
        else
            echo "âŒ"
        fi
    elif [ "$check_type" = "brew" ]; then
        if brew services list | grep -q "$name.*started"; then
            echo "âœ…"
        else
            echo "âŒ"
        fi
    else
        echo "â“"
    fi
}

# Function to start services
start_services() {
    echo "ğŸš€ Starting Nullblock services..."
    echo ""
    
    # Start infrastructure services
    echo "ğŸ“¦ Starting infrastructure services..."
    brew services start postgresql@17
    brew services start redis
    echo "âœ… Infrastructure services started"
    echo ""
    
    # Start IPFS
    echo "ğŸŒ Starting IPFS daemon..."
    ipfs daemon --enable-gc &
    echo "âœ… IPFS daemon started"
    echo ""
    
    # Start backend services
    echo "ğŸ”§ Starting backend services..."
    
    # MCP Server
    echo "  ğŸ“¡ Starting MCP Server on port ${services.mcp_server}..."
    cd "$PROJECT_ROOT/svc/nullblock-mcp"
    export MCP_SERVER_HOST=${hosts.mcp_server}
    export MCP_SERVER_PORT=${services.mcp_server}
    hatch run python3 -m mcp &
    echo "  âœ… MCP Server started"
    
    # Orchestration
    echo "  ğŸ”„ Starting Orchestration on port ${services.orchestration}..."
    cd "$PROJECT_ROOT/svc/nullblock-orchestration"
    export ORCHESTRATION_HOST=${hosts.orchestration}
    export ORCHESTRATION_PORT=${services.orchestration}
    hatch run python3 -m orchestration &
    echo "  âœ… Orchestration started"
    
    # Erebus
    echo "  ğŸ¦€ Starting Erebus on port ${services.erebus}..."
    cd "$PROJECT_ROOT/svc/erebus"
    export EREBUS_HOST=${hosts.erebus}
    export EREBUS_PORT=${services.erebus}
    cargo run &
    echo "  âœ… Erebus started"
    echo ""
    
    # Start agent services
    echo "ğŸ¤– Starting agent services..."
    
    # General Agents
    echo "  ğŸ¯ Starting General Agents on port ${services.general_agents}..."
    cd "$PROJECT_ROOT/svc/nullblock-agents"
    mkdir -p logs
    export AGENTS_HOST=${hosts.general_agents}
    export AGENTS_PORT=${services.general_agents}
    hatch run python3 -m agents > logs/agents.log 2>&1 &
    echo "  âœ… General Agents started"
    
    # Hecate Agent
    echo "  ğŸ­ Starting Hecate Agent on port ${services.hecate_agent}..."
    cd "$PROJECT_ROOT/svc/nullblock-agents"
    export HECATE_HOST=${hosts.hecate_agent}
    export HECATE_PORT=${services.hecate_agent}
    hatch run python3 start_hecate_server.py > logs/hecate-server.log 2>&1 &
    echo "  âœ… Hecate Agent started"
    echo ""
    
    # Start frontend
    echo "ğŸŒ Starting frontend..."
    cd "$PROJECT_ROOT/svc/hecate"
    export VITE_MCP_API_URL=http://${hosts.mcp_server}:${services.mcp_server}
    export VITE_EREBUS_API_URL=http://${hosts.erebus}:${services.erebus}
    export VITE_ORCHESTRATION_API_URL=http://${hosts.orchestration}:${services.orchestration}
    export VITE_AGENTS_API_URL=http://${hosts.general_agents}:${services.general_agents}
    export VITE_HECATE_API_URL=http://${hosts.hecate_agent}:${services.hecate_agent}
    npm run develop &
    echo "âœ… Frontend started"
    echo ""
    
    echo "ğŸ‰ All services started successfully!"
    echo "ğŸ’¡ Use './monitor-health.sh' to check service status"
    echo "ğŸ’¡ Use './stop-services.sh' to stop all services"
}

# Function to stop services
stop_services() {
    echo "ğŸ›‘ Stopping Nullblock services..."
    echo ""
    
    # Stop infrastructure services
    echo "ğŸ“¦ Stopping infrastructure services..."
    brew services stop postgresql@17
    brew services stop redis
    echo "âœ… Infrastructure services stopped"
    echo ""
    
    # Stop IPFS
    echo "ğŸŒ Stopping IPFS daemon..."
    pkill -f "ipfs daemon" || true
    echo "âœ… IPFS daemon stopped"
    echo ""
    
    # Stop services by port
    echo "ğŸ”§ Stopping backend and agent services..."
    lsof -ti:${services.mcp_server} | xargs kill -9 2>/dev/null || true
    lsof -ti:${services.orchestration} | xargs kill -9 2>/dev/null || true
    lsof -ti:${services.erebus} | xargs kill -9 2>/dev/null || true
    lsof -ti:${services.general_agents} | xargs kill -9 2>/dev/null || true
    lsof -ti:${services.hecate_agent} | xargs kill -9 2>/dev/null || true
    lsof -ti:${services.frontend} | xargs kill -9 2>/dev/null || true
    lsof -ti:${services.lm_studio} | xargs kill -9 2>/dev/null || true
    echo "âœ… Backend and agent services stopped"
    echo ""
    
    # Clean up PID files
    echo "ğŸ§¹ Cleaning up PID files..."
    rm -f logs/*.pid 2>/dev/null || true
    echo "âœ… PID files cleaned"
    echo ""
    
    echo "ğŸ‰ All services stopped successfully!"
}

# Function to restart services
restart_services() {
    echo "ğŸ”„ Restarting Nullblock services..."
    echo ""
    
    stop_services
    sleep 3
    start_services
}

# Function to check service status
status_services() {
    echo "ğŸ“Š NULLBLOCK SERVICE STATUS"
    echo "==========================="
    echo "Environment: ${environment}"
    echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
    echo ""
    
    printf "%-25s %-15s %-10s %s\n" "SERVICE" "PORT" "STATUS" "DETAILS"
    printf "%-25s %-15s %-10s %s\n" "-------" "----" "------" "-------"
    
    # Infrastructure Services
    postgresql_status=$(check_service "postgresql@17" "" "" "brew")
    printf "%-25s %-15s %-10s %s\n" "PostgreSQL" "brew service" "$postgresql_status" "Database"
    
    redis_status=$(check_service "redis" "" "" "brew")
    printf "%-25s %-15s %-10s %s\n" "Redis" "brew service" "$redis_status" "Cache"
    
    # Check if IPFS is running
    if pgrep -f "ipfs daemon" > /dev/null; then
        ipfs_status="âœ…"
    else
        ipfs_status="âŒ"
    fi
    printf "%-25s %-15s %-10s %s\n" "IPFS Daemon" "process" "$ipfs_status" "File System"
    
    # Backend Services
    mcp_status=$(check_service "MCP" "${services.mcp_server}" "http://localhost:${services.mcp_server}/health" "http")
    printf "%-25s %-15s %-10s %s\n" "MCP Server" "${services.mcp_server}" "$mcp_status" "Protocol Server"
    
    orch_status=$(check_service "Orchestration" "${services.orchestration}" "http://localhost:${services.orchestration}/health" "http")
    printf "%-25s %-15s %-10s %s\n" "Orchestration" "${services.orchestration}" "$orch_status" "Workflow Engine"
    
    erebus_status=$(check_service "Erebus" "${services.erebus}" "http://localhost:${services.erebus}/health" "http")
    printf "%-25s %-15s %-10s %s\n" "Erebus" "${services.erebus}" "$erebus_status" "Rust Backend"
    
    # Agent Services
    agents_status=$(check_service "General Agents" "${services.general_agents}" "http://localhost:${services.general_agents}/health" "http")
    printf "%-25s %-15s %-10s %s\n" "General Agents" "${services.general_agents}" "$agents_status" "Agent Services"
    
    hecate_status=$(check_service "Hecate Agent" "${services.hecate_agent}" "http://localhost:${services.hecate_agent}/health" "http")
    printf "%-25s %-15s %-10s %s\n" "Hecate Agent" "${services.hecate_agent}" "$hecate_status" "Chat Interface"
    
    # Frontend Services
    frontend_status=$(check_service "Frontend" "${services.frontend}" "http://localhost:${services.frontend}" "http")
    printf "%-25s %-15s %-10s %s\n" "Frontend" "${services.frontend}" "$frontend_status" "Vite Dev Server"
    
    # LM Studio
    if lsof -i :${services.lm_studio} > /dev/null 2>&1; then
        lm_status="âœ…"
    else
        lm_status="âŒ"
    fi
    printf "%-25s %-15s %-10s %s\n" "LM Studio" "${services.lm_studio}" "$lm_status" "LLM Server"
    
    echo ""
    
    # Count online/offline services
    total_services=9
    online_services=$(printf "%s\n%s\n%s\n%s\n%s\n%s\n%s\n%s\n%s" "$postgresql_status" "$redis_status" "$ipfs_status" "$mcp_status" "$orch_status" "$erebus_status" "$agents_status" "$hecate_status" "$frontend_status" | grep -c "âœ…")
    offline_services=$((total_services - online_services))
    
    echo "ğŸ“Š SUMMARY: $online_services/$total_services services online ($offline_services offline)"
    
    if [ $offline_services -eq 0 ]; then
        echo "ğŸ‰ ALL SERVICES ARE ONLINE! ğŸ‰"
    else
        echo "âš ï¸  $offline_services service(s) still offline"
    fi
}

# Main script logic
case "${action}" in
    "start")
        start_services
        ;;
    "stop")
        stop_services
        ;;
    "restart")
        restart_services
        ;;
    "status")
        status_services
        ;;
    *)
        echo "âŒ Unknown action: ${action}"
        echo "Available actions: start, stop, restart, status"
        exit 1
        ;;
esac
