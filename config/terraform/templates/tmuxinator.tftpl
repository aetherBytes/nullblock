# Generated tmuxinator configuration for Nullblock development
# Generated by Terraform for environment: ${environment}
# Generated on: ${formatdate("YYYY-MM-DD HH:mm:ss", timestamp())}

name: nullblock-dev
root: ~/nullblock

on_project_start:
  - |
    if [ ! -f .env.dev ]; then
      echo "Creating .env.dev file..."
      echo "# Nullblock Development Environment" > .env.dev
      echo "ETHEREUM_RPC_URL=https://eth-sepolia.alchemyapi.io/v2/your-key" >> .env.dev
      echo "Please edit .env.dev with your actual API keys"
    fi
    echo "Creating logs directory for agent services..."
    mkdir -p logs
    echo "üöÄ Nullblock development environment ready!"
    echo "ü§ñ Agents tab: General agents (${services.general_agents}) + Hecate server (${services.hecate_agent}) with comprehensive logging"
    echo "üåê Frontend connects to Hecate agent for chat functionality"
    echo "üí° Use 'tail -f logs/*.log' to monitor all service logs"

on_project_first_start:
  - echo "First time setup complete!"

on_project_exit:
  - echo "Development environment stopped"

windows:
  - infrastructure:
      layout: even-horizontal
      panes:
        - |
          echo "Starting PostgreSQL..."
          brew services start postgresql@17
          echo "PostgreSQL started"
        - |
          echo "Starting Redis..."
          brew services start redis
          echo "Redis started"
        - |
          echo "Starting IPFS..."
          ipfs daemon --enable-gc

  - backend:
      layout: tiled
      panes:
        - |
          echo "Starting MCP Server..."
          cd svc/nullblock-mcp
          echo "Installing/updating dependencies with hatch..."
          hatch -e default run pip install -e .
          export MCP_SERVER_HOST=${hosts.mcp_server}
          export MCP_SERVER_PORT=${services.mcp_server}
          hatch run python3 -m mcp
        - |
          echo "Starting Orchestration..."
          cd svc/nullblock-orchestration
          echo "Installing/updating dependencies with hatch..."
          hatch -e default run pip install -e .
          export ORCHESTRATION_HOST=${hosts.orchestration}
          export ORCHESTRATION_PORT=${services.orchestration}
          hatch run python3 -m orchestration
        - |
          echo "Starting Erebus Server..."
          cd svc/erebus
          echo "Updating Rust dependencies..."
          cargo update
          export EREBUS_HOST=${hosts.erebus}
          export EREBUS_PORT=${services.erebus}
          cargo run

  - agents:
      layout: even-horizontal
      panes:
        - |
          echo "ü§ñ Starting Nullblock Agents Server..."
          cd svc/nullblock-agents
          echo "Installing/updating dependencies with hatch..."
          hatch -e default run pip install -e .
          echo "Creating logs directory..."
          mkdir -p logs
          export AGENTS_HOST=${hosts.general_agents}
          export AGENTS_PORT=${services.general_agents}
          echo "üöÄ Starting general agents server on port ${services.general_agents}..."
          echo "üìù Logs will be written to logs/agents.log"
          echo "üí° Use 'tail -f logs/agents.log' to monitor logs"
          hatch run python3 -m agents
        - |
          echo "üéØ Starting Hecate Agent Server..."
          cd svc/nullblock-agents
          echo "Ensuring dependencies are installed..."
          hatch -e default run pip install -e .
          echo "Creating logs directory..."
          mkdir -p logs
          export HECATE_HOST=${hosts.hecate_agent}
          export HECATE_PORT=${services.hecate_agent}
          echo "ü§ñ Starting Hecate HTTP API server on port ${services.hecate_agent}..."
          echo "üì° Frontend chat interface will connect to this server"
          echo "üìù Logs will be written to logs/hecate-server.log"
          echo "üí° Use 'tail -f logs/hecate-server.log' to monitor logs"
          echo "üîç Health check: http://localhost:${services.hecate_agent}/health"
          echo "üìö API docs: http://localhost:${services.hecate_agent}/docs"
          hatch run python3 start_hecate_server.py

  - frontend:
      panes:
        - |
          echo "Starting Frontend..."
          cd svc/hecate
          echo "Installing/updating npm dependencies..."
          npm install
          export VITE_MCP_API_URL=http://${hosts.mcp_server}:${services.mcp_server}
          export VITE_EREBUS_API_URL=http://${hosts.erebus}:${services.erebus}
          export VITE_ORCHESTRATION_API_URL=http://${hosts.orchestration}:${services.orchestration}
          export VITE_AGENTS_API_URL=http://${hosts.general_agents}:${services.general_agents}
          export VITE_HECATE_API_URL=http://${hosts.hecate_agent}:${services.hecate_agent}
          npm run develop

  - llm:
      layout: even-horizontal
      panes:
        - ~/nullblock/scripts/start-lmstudio.sh
        - |
          echo "Waiting for LM Studio server to start..."
          sleep 10
          echo "üìä Starting log monitoring..."
          echo "Press Ctrl+C to stop"
          echo ""
          echo "üìä Monitoring LM Studio server logs..."
          while true; do
            lms log stream 2>/dev/null || echo "‚ö†Ô∏è  No recent log files found in LM Studio server logs"
            sleep 5
          done
        - ~/nullblock/scripts/wait-for-lmstudio.sh

  - logs:
      layout: even-horizontal
      panes:
        - |
          echo "üìä MASTER LOGS - All Services Combined"
          echo "üéØ Monitoring all service logs in real-time"
          echo "üí° Press Ctrl+C to stop monitoring"
          echo "=" * 80
          echo ""
          echo "üìã Available log files:"
          ls -la logs/ | grep -E "\\.log$" || echo "  No log files found yet"
          echo ""
          echo "üîÑ Starting unified log stream..."
          echo "=" * 80
          tail -f logs/*.log
        - |
          echo "üìà COMPREHENSIVE HEALTH MONITORING"
          echo "üîç Real-time service status and log analysis"
          echo "=" * 80
          echo ""
          
          # Function to check if a service is running
          check_service() {
            local name="$1"
            local port="$2"
            local url="$3"
            local check_type="$4"
            
            if [ "$check_type" = "port" ]; then
              if lsof -i :$port > /dev/null 2>&1; then
                echo "‚úÖ"
              else
                echo "‚ùå"
              fi
            elif [ "$check_type" = "http" ]; then
              if curl -s --max-time 3 "$url" > /dev/null 2>&1; then
                echo "‚úÖ"
              else
                echo "‚ùå"
              fi
            elif [ "$check_type" = "brew" ]; then
              if brew services list | grep -q "$name.*started"; then
                echo "‚úÖ"
              else
                echo "‚ùå"
              fi
            else
              echo "‚ùì"
            fi
          }
          
          # Function to print status table
          print_status_table() {
            local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
            echo "üïê $timestamp - COMPREHENSIVE SERVICE STATUS"
            echo "=" * 80
            echo ""
            printf "%-25s %-15s %-10s %-15s %s\n" "SERVICE" "PORT/CHECK" "STATUS" "RESPONSE TIME" "DETAILS"
            printf "%-25s %-15s %-10s %-15s %s\n" "-------" "----------" "------" "-------------" "-------"
            
            # Infrastructure Services
            postgresql_status=$(check_service "postgresql@17" "" "" "brew")
            printf "%-25s %-15s %-10s %-15s %s\n" "PostgreSQL" "brew service" "$postgresql_status" "-" "Database"
            
            redis_status=$(check_service "redis" "" "" "brew")
            printf "%-25s %-15s %-10s %-15s %s\n" "Redis" "brew service" "$redis_status" "-" "Cache"
            
            # Check if IPFS is running
            if pgrep -f "ipfs daemon" > /dev/null; then
              ipfs_status="‚úÖ"
            else
              ipfs_status="‚ùå"
            fi
            printf "%-25s %-15s %-10s %-15s %s\n" "IPFS Daemon" "process" "$ipfs_status" "-" "File System"
            
            # Backend Services
            mcp_status=$(check_service "MCP" "${services.mcp_server}" "http://localhost:${services.mcp_server}/health" "http")
            mcp_time=$(curl -s --max-time 3 -w "%%{time_total}" http://localhost:${services.mcp_server}/health -o /dev/null 2>/dev/null || echo "N/A")
            printf "%-25s %-15s %-10s %-15s %s\n" "MCP Server" "${services.mcp_server}" "$mcp_status" "${mcp_time}s" "Protocol Server"
            
            orch_status=$(check_service "Orchestration" "${services.orchestration}" "http://localhost:${services.orchestration}/health" "http")
            orch_time=$(curl -s --max-time 3 -w "%%{time_total}" http://localhost:${services.orchestration}/health -o /dev/null 2>/dev/null || echo "N/A")
            printf "%-25s %-15s %-10s %-15s %s\n" "Orchestration" "${services.orchestration}" "$orch_status" "${orch_time}s" "Workflow Engine"
            
            erebus_status=$(check_service "Erebus" "${services.erebus}" "http://localhost:${services.erebus}/health" "http")
            erebus_time=$(curl -s --max-time 3 -w "%%{time_total}" http://localhost:${services.erebus}/health -o /dev/null 2>/dev/null || echo "N/A")
            printf "%-25s %-15s %-10s %-15s %s\n" "Erebus" "${services.erebus}" "$erebus_status" "${erebus_time}s" "Rust Backend"
            
            # Agent Services
            agents_status=$(check_service "General Agents" "${services.general_agents}" "http://localhost:${services.general_agents}/health" "http")
            agents_time=$(curl -s --max-time 3 -w "%%{time_total}" http://localhost:${services.general_agents}/health -o /dev/null 2>/dev/null || echo "N/A")
            printf "%-25s %-15s %-10s %-15s %s\n" "General Agents" "${services.general_agents}" "$agents_status" "${agents_time}s" "Agent Services"
            
            hecate_status=$(check_service "Hecate Agent" "${services.hecate_agent}" "http://localhost:${services.hecate_agent}/health" "http")
            hecate_time=$(curl -s --max-time 3 -w "%%{time_total}" http://localhost:${services.hecate_agent}/health -o /dev/null 2>/dev/null || echo "N/A")
            printf "%-25s %-15s %-10s %-15s %s\n" "Hecate Agent" "${services.hecate_agent}" "$hecate_status" "${hecate_time}s" "Chat Interface"
            
            # Frontend Services
            frontend_status=$(check_service "Frontend" "${services.frontend}" "http://localhost:${services.frontend}" "http")
            frontend_time=$(curl -s --max-time 3 -w "%%{time_total}" http://localhost:${services.frontend} -o /dev/null 2>/dev/null || echo "N/A")
            printf "%-25s %-15s %-10s %-15s %s\n" "Frontend" "${services.frontend}" "$frontend_status" "${frontend_time}s" "Vite Dev Server"
            
            # LM Studio
            if lsof -i :${services.lm_studio} > /dev/null 2>&1; then
              lm_status="‚úÖ"
              lm_time="N/A"
            else
              lm_status="‚ùå"
              lm_time="N/A"
            fi
            printf "%-25s %-15s %-10s %-15s %s\n" "LM Studio" "${services.lm_studio}" "$lm_status" "$lm_time" "LLM Server"
            
            echo ""
            echo "=" * 80
            
            # Count online/offline services
            total_services=9
            online_services=$(printf "%s\n%s\n%s\n%s\n%s\n%s\n%s\n%s\n%s" "$postgresql_status" "$redis_status" "$ipfs_status" "$mcp_status" "$orch_status" "$erebus_status" "$agents_status" "$hecate_status" "$frontend_status" | grep -c "‚úÖ")
            offline_services=$((total_services - online_services))
            
            echo "üìä SUMMARY: $online_services/$total_services services online ($offline_services offline)"
            
            if [ $offline_services -eq 0 ]; then
              echo "üéâ ALL SERVICES ARE ONLINE! üéâ"
            else
              echo "‚ö†Ô∏è  $offline_services service(s) still offline"
            fi
            
            echo ""
          }
          
          # Function to show log statistics
          show_log_stats() {
            echo "üìã LOG FILE STATISTICS:"
            echo "----------------------"
            if [ -d logs ]; then
              for logfile in logs/*.log; do
                if [ -f "$logfile" ]; then
                  size=$(du -h "$logfile" | cut -f1)
                  lines=$(wc -l < "$logfile" 2>/dev/null || echo "0")
                  last_modified=$(stat -f "%Sm" -t "%H:%M:%S" "$logfile" 2>/dev/null || echo "N/A")
                  echo "  üìÑ $(basename "$logfile"): $size ($lines lines) - Last: $last_modified"
                fi
              done
            else
              echo "  üìÅ No logs directory found"
            fi
            echo ""
          }
          
          # Function to show system resources
          show_system_resources() {
            echo "üíª SYSTEM RESOURCES:"
            echo "-------------------"
            cpu_usage=$(top -l 1 | grep "CPU usage" | awk '{print $3}' | sed 's/%//')
            memory_info=$(vm_stat | grep "Pages free" | awk '{print $3}' | sed 's/\.//')
            memory_mb=$((memory_info * 4096 / 1024 / 1024))
            disk_usage=$(df -h . | tail -1 | awk '{print $5}')
            echo "  üñ•Ô∏è  CPU Usage: ${cpu_usage}%"
            echo "  üíæ Memory Free: ${memory_mb}MB"
            echo "  üíø Disk Usage: $disk_usage"
            echo ""
          }
          
          # Initial status check
          print_status_table
          show_log_stats
          show_system_resources
          
          # Continuous monitoring
          check_count=0
          while true; do
            check_count=$((check_count + 1))
            
            # Check every 15 seconds until all services are online
            if [ $check_count -le 40 ]; then  # 40 checks = 10 minutes
              sleep 15
              clear
              echo "üìà COMPREHENSIVE HEALTH MONITORING"
              echo "üîç Real-time service status and log analysis"
              echo "=" * 80
              echo ""
              print_status_table
              show_log_stats
              show_system_resources
            else
              # After 10 minutes, switch to 5-minute intervals
              sleep 300  # 5 minutes
              clear
              echo "üìà COMPREHENSIVE HEALTH MONITORING"
              echo "üîç Real-time service status and log analysis"
              echo "=" * 80
              echo ""
              print_status_table
              show_log_stats
              show_system_resources
            fi
          done

  - workspace:
      layout: even-horizontal
      panes:
        - |
          echo "Nullblock Main Repository"
          echo "Available commands:"
          echo "  just help - Show all commands"
          echo "  just dev-tmux - Launch dev environment"
          echo "  just start - Start all services"
          echo "  just status - Check service status"
          cd ~/nullblock
        - |
          echo "Nullblock SDK Repository"
          echo "Available commands:"
          echo "  npm run build - Build SDK"
          echo "  npm test - Run tests"
          echo "  npm run docs - Generate docs"
          cd ~/nullblock-sdk
