#!/bin/bash

# Generated health monitoring script for Nullblock services
# Generated by Terraform for environment: dev
# Generated on: 2025-08-19 03:50:17

set -e

echo "ğŸ¥ NULLBLOCK HEALTH MONITOR"
echo "=========================="
echo "Environment: dev"
echo "Generated: 2025-08-19 03:50:17"
echo ""

# Function to check if a service is running
check_service() {
    local name="$1"
    local port="$2"
    local check_type="$3"
    
    if [ "$check_type" = "port" ]; then
        if lsof -i :$port > /dev/null 2>&1; then
            echo "âœ…"
        else
            echo "âŒ"
        fi
    elif [ "$check_type" = "brew" ]; then
        if brew services list | grep -q "$name.*started"; then
            echo "âœ…"
        else
            echo "âŒ"
        fi
    else
        echo "â“"
    fi
}

# Function to print status table
print_status_table() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "ğŸ• $timestamp - SERVICE STATUS"
    echo "=" * 50
    echo ""
    printf "%-25s %-15s %-10s %s\n" "SERVICE" "PORT" "STATUS" "DETAILS"
    printf "%-25s %-15s %-10s %s\n" "-------" "----" "------" "-------"
    
    # Infrastructure Services
    postgresql_status=$(check_service "postgresql@17" "" "brew")
    printf "%-25s %-15s %-10s %s\n" "PostgreSQL" "brew service" "$postgresql_status" "Database"
    
    redis_status=$(check_service "redis" "" "brew")
    printf "%-25s %-15s %-10s %s\n" "Redis" "brew service" "$redis_status" "Cache"
    
    # Check if IPFS is running
    if pgrep -f "ipfs daemon" > /dev/null; then
        ipfs_status="âœ…"
    else
        ipfs_status="âŒ"
    fi
    printf "%-25s %-15s %-10s %s\n" "IPFS Daemon" "process" "$ipfs_status" "File System"
    
    # Backend Services
    mcp_status=$(check_service "MCP" "8001" "port")
    printf "%-25s %-15s %-10s %s\n" "MCP Server" "8001" "$mcp_status" "Protocol Server"
    
    orch_status=$(check_service "Orchestration" "8002" "port")
    printf "%-25s %-15s %-10s %s\n" "Orchestration" "8002" "$orch_status" "Workflow Engine"
    
    erebus_status=$(check_service "Erebus" "3000" "port")
    printf "%-25s %-15s %-10s %s\n" "Erebus" "3000" "$erebus_status" "Rust Backend"
    
    # Agent Services
    agents_status=$(check_service "General Agents" "9001" "port")
    printf "%-25s %-15s %-10s %s\n" "General Agents" "9001" "$agents_status" "Agent Services"
    
    hecate_status=$(check_service "Hecate Agent" "9002" "port")
    printf "%-25s %-15s %-10s %s\n" "Hecate Agent" "9002" "$hecate_status" "Chat Interface"
    
    # Frontend Services
    frontend_status=$(check_service "Frontend" "5173" "port")
    printf "%-25s %-15s %-10s %s\n" "Frontend" "5173" "$frontend_status" "Vite Dev Server"
    
    # LM Studio
    lm_status=$(check_service "LM Studio" "1234" "port")
    printf "%-25s %-15s %-10s %s\n" "LM Studio" "1234" "$lm_status" "LLM Server"
    
    echo ""
    echo "=" * 50
    
    # Count online/offline services
    total_services=9
    online_services=$(printf "%s\n%s\n%s\n%s\n%s\n%s\n%s\n%s\n%s" "$postgresql_status" "$redis_status" "$ipfs_status" "$mcp_status" "$orch_status" "$erebus_status" "$agents_status" "$hecate_status" "$frontend_status" | grep -c "âœ…")
    offline_services=$((total_services - online_services))
    
    echo "ğŸ“Š SUMMARY: $online_services/$total_services services online ($offline_services offline)"
    
    if [ $offline_services -eq 0 ]; then
        echo "ğŸ‰ ALL SERVICES ARE ONLINE! ğŸ‰"
    else
        echo "âš ï¸  $offline_services service(s) still offline"
    fi
    
    echo ""
}

# Function to show log statistics
show_log_stats() {
    echo "ğŸ“‹ LOG FILE STATISTICS:"
    echo "----------------------"
    if [ -d logs ]; then
        for logfile in logs/*.log; do
            if [ -f "$logfile" ]; then
                size=$(du -h "$logfile" | cut -f1)
                lines=$(wc -l < "$logfile" 2>/dev/null || echo "0")
                last_modified=$(stat -f "%Sm" -t "%H:%M:%S" "$logfile" 2>/dev/null || echo "N/A")
                echo "  ğŸ“„ $(basename "$logfile"): $size ($lines lines) - Last: $last_modified"
            fi
        done
    else
        echo "  ğŸ“ No logs directory found"
    fi
    echo ""
}

# Function to show system resources
show_system_resources() {
    echo "ğŸ’» SYSTEM RESOURCES:"
    echo "-------------------"
    cpu_usage=$(top -l 1 | grep "CPU usage" | awk '{print $3}' | sed 's/%//')
    memory_info=$(vm_stat | grep "Pages free" | awk '{print $3}' | sed 's/\.//')
    memory_mb=$((memory_info * 4096 / 1024 / 1024))
    disk_usage=$(df -h . | tail -1 | awk '{print $5}')
    echo "  ğŸ–¥ï¸  CPU Usage: ${cpu_usage}%"
    echo "  ğŸ’¾ Memory Free: ${memory_mb}MB"
    echo "  ğŸ’¿ Disk Usage: ${disk_usage}"
    echo ""
}

# Main monitoring loop
if [ "$1" = "once" ]; then
    # Single check
    print_status_table
    show_log_stats
    show_system_resources
else
    # Continuous monitoring
    echo "ğŸ”„ Starting continuous health monitoring..."
    echo "ğŸ’¡ Press Ctrl+C to stop"
    echo ""
    
    check_count=0
    while true; do
        check_count=$((check_count + 1))
        
        # Check every 15 seconds until all services are online
        if [ $check_count -le 40 ]; then  # 40 checks = 10 minutes
            sleep 15
            clear
            echo "ğŸ¥ NULLBLOCK HEALTH MONITOR"
            echo "=========================="
            echo ""
            print_status_table
            show_log_stats
            show_system_resources
        else
            # After 10 minutes, switch to 5-minute intervals
            sleep 300  # 5 minutes
            clear
            echo "ğŸ¥ NULLBLOCK HEALTH MONITOR"
            echo "=========================="
            echo ""
            print_status_table
            show_log_stats
            show_system_resources
        fi
    done
fi
